/**
 * @license
 * @version 0.3.0
 * The MIT License (MIT)
 * 
 * Copyright (c) 2015 Thomas Roch
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
(function(t){var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(t,r.key,r)}}return function(e,n,r){if(n)t(e.prototype,n);if(r)t(e,r);return e}}();function n(t,e){if(!(t instanceof e)){throw new TypeError("Cannot call a class as a function")}}var r=function r(t){return"("+(t?t.replace(/(^<|>$)/g,""):"[a-zA-Z0-9-_.~]+")+")"};var a=[{name:"url-parameter",pattern:/^:([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function i(t){return new RegExp(r(t[2]))}},{name:"url-parameter-splat",pattern:/^\*([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/,regex:/([^\?]*)/},{name:"url-parameter-matrix",pattern:/^\;([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function i(t){return new RegExp(";"+t[1]+"="+r(t[2]))}},{name:"query-parameter",pattern:/^(?:\?|&)(?:\:)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/},{name:"delimiter",pattern:/^(\/|\?)/,regex:function i(t){return new RegExp(t[0])}},{name:"sub-delimiter",pattern:/^(\!|\&|\-|_|\.|;)/,regex:function i(t){return new RegExp(t[0])}},{name:"fragment",pattern:/^([0-9a-zA-Z]+?)/,regex:function i(t){return new RegExp(t[0])}}];var u=function u(t){var e=arguments[1]===undefined?[]:arguments[1];var n=a.some(function(n){var r=t.match(n.pattern);if(!r)return false;e.push({type:n.name,match:r[0],val:r.slice(1,2),otherVal:r.slice(2),regex:n.regex instanceof Function?n.regex(r):n.regex});if(r[0].length<t.length)e=u(t.substr(r[0].length),e);return true});if(!n){throw new Error("Could not parse path.")}return e};var s=function(){function t(e){n(this,t);if(!e)throw new Error("Please supply a path");this.path=e;this.tokens=u(e);this.hasUrlParams=this.tokens.filter(function(t){return/^url-parameter/.test(t.type)}).length>0;this.hasSpatParam=this.tokens.filter(function(t){return/splat$/.test(t.type)}).length>0;this.hasMatrixParams=this.tokens.filter(function(t){return/matrix$/.test(t.type)}).length>0;this.hasQueryParams=this.tokens.filter(function(t){return t.type==="query-parameter"}).length>0;this.urlParams=!this.hasUrlParams?[]:this.tokens.filter(function(t){return/^url-parameter/.test(t.type)}).map(function(t){return t.val.slice(0,1)}).reduce(function(t,e){return t.concat(e)});this.queryParams=!this.hasQueryParams?[]:this.tokens.filter(function(t){return t.type==="query-parameter"}).map(function(t){return t.val}).reduce(function(t,e){return t.concat(e)});this.params=this.urlParams.concat(this.queryParams);this.source=this.tokens.filter(function(t){return t.regex!==undefined}).map(function(t){return t.regex.source}).join("")}e(t,[{key:"_urlMatch",value:function a(t,e){var n=this;var r=t.match(e);if(!r)return null;else if(!this.urlParams.length)return{};return r.slice(1,this.urlParams.length+1).reduce(function(t,e,r){t[n.urlParams[r]]=e;return t},{})}},{key:"match",value:function i(t){var e=this;var n=this._urlMatch(t,new RegExp("^"+this.source+(this.hasQueryParams?"?.*$":"$")));if(!n||!this.hasQueryParams)return n;var r=t.split("?")[1].split("&").map(function(t){return t.split("=")}).reduce(function(t,e){t[e[0]]=e[1];return t},{});if(Object.keys(r).every(function(t){return Object.keys(e.queryParams).indexOf(t)!==1})&&Object.keys(r).length===this.queryParams.length){Object.keys(r).forEach(function(t){return n[t]=r[t]});return n}return null}},{key:"partialMatch",value:function s(t){return this._urlMatch(t,new RegExp("^"+this.source))}},{key:"build",value:function o(){var t=arguments[0]===undefined?{}:arguments[0];var e=arguments[1]===undefined?false:arguments[1];if(!this.params.every(function(e){return t[e]!==undefined}))throw new Error("Missing parameters");if(!e){var n=this.tokens.filter(function(t){return/^url-parameter/.test(t.type)&&!/-splat$/.test(t.type)}).every(function(e){return new RegExp("^"+r(e.otherVal[0])+"$").test(t[e.val])});if(!n)throw new Error("Some parameters are of invalid format")}var a=this.tokens.filter(function(t){return t.type!=="query-parameter"}).map(function(e){if(e.type==="url-parameter-matrix")return";"+e.val[0]+"="+t[e.val[0]];return/^url-parameter/.test(e.type)?t[e.val[0]]:e.match}).join("");var i=this.queryParams.map(function(e){return e+"="+t[e]}).join("&");return a+(i?"?"+i:"")}}]);return t}();var o=function(){function t(){var e=arguments[0]===undefined?"":arguments[0];var r=arguments[1]===undefined?"":arguments[1];var a=arguments[2]===undefined?[]:arguments[2];n(this,t);this.name=e;this.path=r;this.parser=r?new s(r):null;this.children=[];this.add(a);return this}e(t,[{key:"add",value:function r(e){var n=this;if(e instanceof Array){e.forEach(function(t){return n.add(t)});return}if(!(e instanceof t)&&!(e instanceof Object)){throw new Error("Route constructor expects routes to be an Object or an instance of Route.")}if(e instanceof Object){if(!e.name||!e.path){throw new Error("Route constructor expects routes to have an name and a path defined.")}e=new t(e.name,e.path,e.children)}if(this.children.map(function(t){return t.name}).indexOf(e.name)!==-1){throw new Error('Alias "'+e.name+'" is already defined in route node')}if(this.children.map(function(t){return t.path}).indexOf(e.path)!==-1){throw new Error('Path "'+e.path+'" is already defined in route node')}var r=e.name.split(".");if(r.length===1){this.children.push(e);this.children.sort(function(t,e){if(!t.parser.hasSpatParam&&e.parser.hasSpatParam)return-1;if(!e.parser.hasSpatParam&&t.parser.hasSpatParam)return 1;if(!t.parser.hasUrlParams&&e.parser.hasUrlParams)return-1;if(!e.parser.hasUrlParams&&t.parser.hasUrlParams)return 1;return t.path&&e.path?t.path.length<e.path.length?1:-1:0})}else{var a=this.getSegmentsByName(r.slice(0,-1).join("."));if(a){a[a.length-1].add(new t(r[r.length-1],e.path,e.children))}else{throw new Error("Could not add route named '"+e.name+"', parent is missing.")}}return this}},{key:"addNode",value:function a(e,n){this.add(new t(e,n));return this}},{key:"getSegmentsByName",value:function i(t){var e=function e(t,e){var n=e.filter(function(e){return e.name===t});return n.length?n[0]:undefined};var n=[];var r=t.split(".");var a=this.children;var i=r.every(function(t){var r=e(t,a);if(r){a=r.children;n.push(r);return true}return false});return i?n:null}},{key:"getSegmentsMatchingPath",value:function u(t){var e=function e(t,n,r){var a=function(a){var i=t[a];var u=i.parser.partialMatch(n);if(u){r.push(i);Object.keys(u).forEach(function(t){return r.params[t]=u[t]});var s=n.replace(i.parser.build(u),"");if(!s.length){return{v:r}}if(!i.children.length){return{v:null}}return{v:e(i.children,s,r)}}};for(var i in t){var u=a(i);if(typeof u==="object")return u.v}return null};var n=this.parser?[this]:this.children;var r=[];r.params={};return e(n,t,r)}},{key:"getPathFromSegments",value:function o(t){return t?t.map(function(t){return t.path}).join(""):null}},{key:"getPath",value:function l(t){return this.getPathFromSegments(this.getSegmentsByName(t))}},{key:"buildPathFromSegments",value:function f(t){var e=arguments[1]===undefined?{}:arguments[1];return t?t.map(function(t){return t.parser.build(e)}).join(""):null}},{key:"buildPath",value:function h(t){var e=arguments[1]===undefined?{}:arguments[1];return this.buildPathFromSegments(this.getSegmentsByName(t),e)}},{key:"getMatchPathFromSegments",value:function c(t){if(!t)return null;var e=t.map(function(t){return t.name}).join(".");var n=t.params;return{name:e,params:n}}},{key:"matchPath",value:function m(t){return this.getMatchPathFromSegments(this.getSegmentsMatchingPath(t))}}]);return t}();var l={ROUTER_NOT_STARTED:"NOT_STARTED",ROUTER_ALREADY_STARTED:"ALREADY_STARTED",SAME_STATES:"SAME_STATES",CANNOT_DEACTIVATE:"CANNOT_DEACTIVATE",CANNOT_ACTIVATE:"CANNOT_ACTIVATE",NODE_LISTENER_ERR:"NODE_ERR",TRANSITION_CANCELLED:"CANCELLED"};function f(){var t=arguments;return function(){return t[0]}}var h=function h(){};var c=typeof t!=="undefined";var m=function m(){return t.location.pathname.replace(/\/$/,"")};var p=function p(e,n,r){return t.history.pushState(e,n,r)};var v=function v(e,n,r){return t.history.replaceState(e,n,r)};var d=function d(e){return t.addEventListener("popstate",e)};var g=function g(e){return t.removeEventListener("popstate",e)};var y=function y(e){var n=e.useHash?t.location.hash.replace(new RegExp("^#"+e.hashPrefix),""):t.location.pathname.replace(new RegExp("^"+e.base),"");return n+t.location.search};var S={};if(c){S={getBase:m,pushState:p,replaceState:v,addPopstateListener:d,removePopstateListener:g,getLocation:y}}else{S={getBase:f(""),pushState:h,replaceState:h,addPopstateListener:h,removePopstateListener:h,getLocation:f("")}}function E(t,e,n,r){var a=arguments[4]===undefined?false:arguments[4];var i=t||[];var u=function u(t){if(!i.length)return true;var r=i[0].length;var u=i[0](e,n,t);if(typeof u==="boolean")t(u?null:true);else if(u&&typeof u.then==="function"){u.then(function(){return t(null)},function(){return t(true)})}else if(r<3&&a)t(null);return false};var s=function s(t){if(t)r(t);else{i=i.slice(1);o()}};var o=function o(){var t=u(s);if(t)r(null)};o()}var _=function _(t){return t.split(".").reduce(function(t,e){return t.concat(t.length?t[t.length-1]+"."+e:e)},[])};function k(t,e,n,r){var a=false;var i=function i(){return a=true};var u=function u(t){return r(a?l.TRANSITION_CANCELLED:t)};var s=undefined;var o=n?_(n.name):[];var f=_(e.name);var h=Math.min(o.length,f.length);for(s=0;s<h;s+=1){if(o[s]!==f[s])break}var c=o.slice(s).reverse();var m=f.slice(s);var p=n&&s>0?o[s-1]:"";var v=function v(e,n,r){if(a)u();else{var i=c.map(function(e){return t._cmps[e]}).filter(function(t){return t&&t.canDeactivate}).map(function(t){return t.canDeactivate});E(i,e,n,function(t){return r(t?l.CANNOT_DEACTIVATE:null)})}};var d=function d(e,n,r){if(a)u();else{var i=m.map(function(e){return t._canAct[e]}).filter(function(t){return t});E(i,e,n,function(t){return r(t?l.CANNOT_ACTIVATE:null)})}};var g=function g(e,n,r){if(a)u();else{var i=t._cbs["^"+p]||[];E(i,e,n,function(t){return r(t?l.NODE_LISTENER_ERR:null)},true)}};var y=n?[v,d,g]:[d,g];E(y,e,n,u);return i}var A=Array.prototype.slice;var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(t,r.key,r)}}return function(e,n,r){if(n)t(e.prototype,n);if(r)t(e,r);return e}}();function n(t,e){if(!(t instanceof e)){throw new TypeError("Cannot call a class as a function")}}var P=function P(t,e,n){return{name:t,params:e,path:n}};var b=function(){function t(e){var r=this;var a=arguments[1]===undefined?{}:arguments[1];n(this,t);this.started=false;this._cbs={};this._cmps={};this._canAct={};this.lastStateAttempt=null;this.lastKnownState=null;this.rootNode=e instanceof o?e:new o("","",e);this.options={useHash:false,hashPrefix:"",base:S.getBase()};Object.keys(a).forEach(function(t){return r.options[t]=a[t]});this.boundOnPopState=this.onPopState.bind(this)}e(t,[{key:"setOption",value:function r(t,e){this.options[t]=e;return this}},{key:"add",value:function a(t){this.rootNode.add(t);return this}},{key:"addNode",value:function i(t,e,n){this.rootNode.addNode(t,e);if(n)this._canAct[t]=n;return this}},{key:"onPopState",value:function u(t){var e=this;var n=t.state||this.matchPath(this.getLocation());if(!n)return;if(this.lastKnownState&&this.areStatesEqual(n,this.lastKnownState))return;this._transition(n,this.lastKnownState,function(t){if(t){var n=e.buildUrl(e.lastKnownState.name,e.lastKnownState.params);S.pushState(e.lastKnownState,"",n)}})}},{key:"start",value:function s(){var t=this;var e=[].concat(A.call(arguments));var n=e.slice(-1)[0];var r=undefined,a=undefined;if(this.started){if(n)n(l.ROUTER_ALREADY_STARTED);return this}if(e.length===2){if(typeof e[0]==="string")r=e[0];if(typeof e[0]==="object")a=e[0]}this.started=true;var i=this.options;var u=function u(e,r){S.addPopstateListener(t.boundOnPopState);if(n)n(e,r)};if(!r&&!a)r=this.getLocation();if(!a){(function(){a=t.matchPath(r);var e=function e(){return t.navigate(i.defaultRoute,i.defaultParams,{replace:true},u)};if(a){t.lastStateAttempt=a;t._transition(t.lastStateAttempt,t.lastKnownState,function(n,r){if(!n){S.replaceState(t.lastKnownState,"",t.buildUrl(a.name,a.params));u(null,r)}else if(i.defaultRoute)e();else u(n)})}else if(i.defaultRoute){e()}else{u(null)}})()}else{this.lastKnownState=a;u(null,a)}return this}},{key:"stop",value:function f(){if(!this.started)return this;this.lastKnownState=null;this.lastStateAttempt=null;this.started=false;S.removePopstateListener(this.boundOnPopState);return this}},{key:"getState",value:function h(){return this.lastKnownState}},{key:"isActive",value:function c(t){var e=arguments[1]===undefined?{}:arguments[1];var n=arguments[2]===undefined?false:arguments[2];var r=this.getState();if(!r)return false;if(n||r.name===t){return this.areStatesEqual(P(t,e),r)}return this.areStatesDescendants(P(t,e),r)}},{key:"areStatesEqual",value:function m(t,e){return t.name===e.name&&Object.keys(t.params).length===Object.keys(e.params).length&&Object.keys(t.params).every(function(n){return t.params[n]===e.params[n]})}},{key:"areStatesDescendants",value:function p(t,e){var n=new RegExp("^"+t.name+"\\.(.*)$");if(!n.test(e.name))return false;return Object.keys(t.params).every(function(n){return t.params[n]===e.params[n]})}},{key:"_invokeListeners",value:function v(t,e,n){(this._cbs[t]||[]).forEach(function(t){return t(e,n)})}},{key:"_addListener",value:function d(t,e,n){var r=t.replace(/^(\*|\^|=)/,"");if(r){var a=this.rootNode.getSegmentsByName(r);if(!a)console.warn("No route found for "+r+", listener might never be called!")}if(!this._cbs[t])this._cbs[t]=[];this._cbs[t]=(n?[]:this._cbs[t]).concat(e);return this}},{key:"_removeListener",value:function g(t,e){if(this._cbs[t])this._cbs[t]=this._cbs[t].filter(function(t){return t!==e});return this}},{key:"addListener",value:function y(t){return this._addListener("*",t)}},{key:"removeListener",value:function E(t){return this._removeListener("*",t)}},{key:"addNodeListener",value:function _(t,e){return this._addListener("^"+t,e,true)}},{key:"removeNodeListener",value:function b(t,e){this._cbs["^"+t]=[];return this}},{key:"addRouteListener",value:function w(t,e){return this._addListener("="+t,e)}},{key:"removeRouteListener",value:function T(t,e){return this._removeListener("="+t,e)}},{key:"registerComponent",value:function R(t,e){if(this._cmps[t])console.warn("A component was alread registered for route node "+t+".");this._cmps[t]=e;return this}},{key:"deregisterComponent",value:function N(t){delete this._cmps[t]}},{key:"canActivate",value:function L(t,e){this._canAct[t]=e;return this}},{key:"getLocation",value:function O(){return S.getLocation(this.options)}},{key:"buildUrl",value:function x(t,e){return this.options.base+(this.options.useHash?"#"+this.options.hashPrefix:"")+this.rootNode.buildPath(t,e)}},{key:"buildPath",value:function C(t,e){return this.rootNode.buildPath(t,e)}},{key:"matchPath",value:function j(t){var e=this.rootNode.matchPath(t);return e?P(e.name,e.params,t):null}},{key:"_transition",value:function D(t,e,n){var r=this;if(this._tr)this._tr();var a=k(this,t,e,function(a){r._tr=null;if(a){if(n)n(a);return}r.lastKnownState=t;r._invokeListeners("="+t.name,t,e);r._invokeListeners("*",t,e);if(n)n(null,t)});this._tr=a;return function(){return!a||a()}}},{key:"navigate",value:function K(t,e,n,r){if(e===undefined)e={};var a=this;if(n===undefined)n={};if(!this.started){r(l.ROUTER_NOT_STARTED);return}var i=this.buildPath(t,e);var u=this.buildUrl(t,e);if(!i)throw new Error('Could not find route "'+t+'"');var s=P(t,e,i);this.lastStateAttempt=s;var o=this.lastKnownState?this.areStatesEqual(this.lastKnownState,this.lastStateAttempt):false;if(o&&!n.reload){if(r)r(l.SAME_STATES);return}return this._transition(s,this.lastKnownState,function(t,e){if(t){if(r)r(t);return}S[n.replace?"replaceState":"pushState"](a.lastStateAttempt,"",u);if(r)r(null,e)})}}]);return t}();b.ERR=l;t.RouteNode=o;t.Router5=b})(window);