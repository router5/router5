!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.router5=e.router5||{})}(this,function(e){"use strict";function t(e,n){return Array.isArray(n)?n.map(function(n){return t(e,n)}).join("&"):!0===n?e:e+"="+n}function n(e){function t(t,n){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(t.name!==n.name)return!1;var a=function(t){return e.rootNode.getSegmentsByName(t).map(function(e){return e.parser[r?"urlParams":"params"]}).reduce(function(e,t){return e.concat(t)},[])},i=a(t.name),o=a(n.name);return i.length===o.length&&i.every(function(e){return t.params[e]===n.params[e]})}function n(e,t){return!!new RegExp("^"+e.name+"\\.(.*)$").test(t.name)&&Object.keys(e.params).every(function(n){return e.params[n]===t.params[n]})}var r=e.getOptions();e.isActive=function(r){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],u=e.getState();return!!u&&(i||u.name===r?t(e.makeState(r,a),u,o):n(e.makeState(r,a),u))},e.areStatesEqual=t,e.areStatesDescendants=n,e.buildPath=function(t,n){if(t===K.UNKNOWN_ROUTE)return n.path;var a=r.useTrailingSlash,i=r.strictQueryParams;return e.rootNode.buildPath(t,n,{trailingSlash:a,strictQueryParams:i})},e.buildState=function(t,n){return e.rootNode.buildState(t,n)},e.matchPath=function(t,n){var a=r.trailingSlash,i=r.strictQueryParams,o=r.strongMatching,u=e.rootNode.matchPath(t,{trailingSlash:a,strictQueryParams:i,strongMatching:o});if(u){var s=u.name,c=u.params,l=u._meta,f=void 0===r.useTrailingSlash?t:e.buildPath(s,c);return e.makeState(s,c,f,l,n)}return null},e.setRootPath=function(t){e.rootNode.setPath(t)}}function r(e){var t=!1,n=e.getOptions();e.isStarted=function(){return t},e.start=function(){var r,a=(r=arguments.length-1,arguments.length<=r?void 0:arguments[r]),i="function"==typeof a?a:V,o="function"!=typeof(arguments.length<=0?void 0:arguments[0])?arguments.length<=0?void 0:arguments[0]:void 0;if(t)return i({code:Z.ROUTER_ALREADY_STARTED}),e;var u=void 0,s=void 0;t=!0,e.invokeEventListeners(K.ROUTER_START);var c=function(t,n){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];t||e.invokeEventListeners(K.TRANSITION_SUCCESS,n,null,{replace:!0}),t&&r&&e.invokeEventListeners(K.TRANSITION_ERROR,n,null,t),i(t,n)};if(void 0===o&&!n.defaultRoute)return c({code:Z.NO_START_PATH_OR_STATE});if("string"==typeof o?u=o:"object"===(void 0===o?"undefined":b(o))&&(s=o),s)e.setState(s),c(null,s);else{var l=function(){return e.navigateToDefault({replace:!0},i)},f=function(t){return e.navigate(t.name,t.params,{replace:!0,reload:!0},i)},h=function(t){e.transitionToState(t,e.getState(),{},function(e,t){e?e.redirect?f(e.redirect):n.defaultRoute?l():c(e,null,!1):c(null,t)})};(s=void 0===u?null:e.matchPath(u))?h(s):n.defaultRoute?l():n.allowNotFound?h(e.makeNotFoundState(u)):c({code:Z.ROUTE_NOT_FOUND,path:u},null)}return e},e.stop=function(){return t&&(e.setState(null),t=!1,e.invokeEventListeners(K.ROUTER_STOP)),e}}function a(e){return e.split(".").reduce(function(e,t){return e.concat(e.length?e[e.length-1]+"."+t:t)},[])}function i(e){return void 0!==e&&null!==e}function o(e){return e&&e.meta&&e.meta.params}function u(e,t){return i(t.meta.params[e])?Object.keys(t.meta.params[e]).reduce(function(e,n){return e[n]=t.params[n],e},{}):{}}function s(e,t){var n=t?a(t.name):[],r=a(e.name),i=Math.min(n.length,r.length),s=void 0;t?o(t)||o(e)?s=function(){var a=void 0;for(a=0;a<i;a+=1){var o=function(){var i=n[a],o=r[a];if(i!==o)return{v:a};var s=u(i,e),c=u(o,t);return s.length!==c.length?{v:a}:0===s.length?"continue":Object.keys(s).some(function(e){return c[e]!==s[e]})?{v:a}:void 0}();switch(o){case"continue":continue;default:if("object"===(void 0===o?"undefined":W(o)))return o.v}}return a}():(console.warn("[router5-transition-path] Some states are missing metadata, reloading all segments"),s=0):s=0;var c=n.slice(s).reverse(),l=r.slice(s);return{intersection:t&&s>0?n[s-1]:"",toDeactivate:c,toActivate:l}}function c(e,t,n){var r=t.isCancelled,a=t.toState,i=t.fromState,o=t.errorKey,u=Array.isArray(e)?e:Object.keys(e),s=function(e){return"object"===(void 0===e?"undefined":b(e))&&void 0!==e.name&&void 0!==e.params&&void 0!==e.path},c=function(e){return e.name!==a.name||e.params!==a.params||e.path!==a.path},l=function(t){if(!u.length)return!0;var n="string"==typeof u[0],s=o&&n?w({},o,u[0]):{},c=(n?e[u[0]]:u[0]).call(null,a,i,t);return r()?t(null):"boolean"==typeof c?t(c?null:s):c&&"function"==typeof c.then&&c.then(function(e){e instanceof Error?t({error:e},null):t(null,e)},function(e){e instanceof Error?(console.error(e.stack||e),t(C({},s,{promiseError:e}),null)):t("object"===(void 0===e?"undefined":b(e))?C({},s,e):s,null)}),!1},f=function(e,t){r()?n():e?n(e):(t&&s(t)&&(c(t)&&console.error("[router5][transition] Warning: state values changed during transition process."),a=t),u=u.slice(1),h())},h=function(){r()?n():l(f)&&n(null,a)};h()}function l(e,t,n,r,i){var o=!1,u=!1,l=e.getOptions(),f=e.getLifecycleFunctions(),h=x(f,2),d=h[0],v=h[1],p=e.getMiddlewareFunctions(),m=function(){return o},g=function(e,t){return C({},e,t instanceof Object?t:{error:t})},y=t.name===K.UNKNOWN_ROUTE,S={isCancelled:m,toState:t,fromState:n},T=s(t,n),E=T.toDeactivate,A=T.toActivate,O=!n||r.forceDeactivate?[]:function(e,t,n){c(E.filter(function(e){return d[e]}).reduce(function(e,t){return C({},e,w({},t,d[t]))},{}),C({},S,{errorKey:"segment"}),function(e){return n(e?g({code:Z.CANNOT_DEACTIVATE},e):null)})},R=y?[]:function(e,t,n){c(A.filter(function(e){return v[e]}).reduce(function(e,t){return C({},e,w({},t,v[t]))},{}),C({},S,{errorKey:"segment"}),function(e){return n(e?g({code:Z.CANNOT_ACTIVATE},e):null)})},N=p.length?function(e,t,n){return c(p,C({},S),function(t,r){return n(t?g({code:Z.TRANSITION_ERR},t):null,r||e)})}:[];return c([].concat(O).concat(R).concat(N),S,function(n,r){if(u=!0,!m()){if(!n&&l.autoCleanUp){var o=a(t.name);Object.keys(d).forEach(function(t){-1===o.indexOf(t)&&e.clearCanDeactivate(t)})}i(n,r||t)}}),function(){o||u||(o=!0,i({code:Z.TRANSITION_CANCELLED},null))}}function f(e){function t(){return a&&(a("navigate"),a=null),e}function n(){var t,a=arguments.length<=0?void 0:arguments[0],i=(t=arguments.length-1,arguments.length<=t?void 0:arguments[t]),o="function"==typeof i?i:G,u="object"===b(arguments.length<=1?void 0:arguments[1])?arguments.length<=1?void 0:arguments[1]:{},s="object"===b(arguments.length<=2?void 0:arguments[2])?arguments.length<=2?void 0:arguments[2]:{};if(e.isStarted()){var c=e.buildState(a,u);if(!c){var l={code:Z.ROUTE_NOT_FOUND};return o(l),void e.invokeEventListeners(K.TRANSITION_ERROR,null,e.getState(),l)}var f=e.makeState(c.name,c.params,e.buildPath(a,u),c._meta),h=!!e.getState()&&e.areStatesEqual(e.getState(),f,!1);if(h&&!s.reload){var d={code:Z.SAME_STATES};return o(d),void e.invokeEventListeners(K.TRANSITION_ERROR,f,e.getState(),d)}var v=h?null:e.getState();return r(f,v,s,function(t,r){if(t)if(t.redirect){var a=t.redirect;n(a.name,a.params,C({},s,{reload:!0}),o)}else o(t);else e.invokeEventListeners(K.TRANSITION_SUCCESS,r,v,s),o(null,r)})}o({code:Z.ROUTER_NOT_STARTED})}function r(n,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:G;return t(),e.invokeEventListeners(K.TRANSITION_START,n,r),a=l(e,n,r,i,function(t,i){a=null,i=i||n,t?(t.code===Z.TRANSITION_CANCELLED?e.invokeEventListeners(K.TRANSITION_CANCEL,n,r):e.invokeEventListeners(K.TRANSITION_ERROR,n,r,t),o(t)):(e.setState(i),o(null,i))})}var a=void 0;e.navigate=n,e.navigateToDefault=function(){var t="object"===b(arguments.length<=0?void 0:arguments[0])?arguments.length<=0?void 0:arguments[0]:{},r=2===arguments.length?arguments.length<=1?void 0:arguments[1]:"function"==typeof(arguments.length<=0?void 0:arguments[0])?arguments.length<=0?void 0:arguments[0]:G,a=e.getOptions();return a.defaultRoute?n(a.defaultRoute,a.defaultParams,t,r):function(){}},e.transitionToState=r,e.cancel=t}function h(e){function t(t){n.push(t),r.push(e.executeFactory(t))}var n=[],r=[];e.useMiddleware=function(){for(var n=arguments.length,r=Array(n),a=0;a<n;a++)r[a]=arguments[a];return r.forEach(t),e},e.getMiddlewareFactories=function(){return n},e.getMiddlewareFunctions=function(){return r},e.clearMiddleware=function(){return n=[],r=[],e}}function d(e){function t(e){n(e)||(a.push(e),r(e))}function n(e){return a.filter(function(t){return t.pluginName===e||t.name===e}).length>0}function r(t){var n=e.executeFactory(t),r=H.map(function(t){if(n[t])return e.addEventListener(t.toLowerCase().replace(/^on/,"$$").replace(/transition/,"$$"),n[t])}).filter(Boolean);i.push.apply(i,I(r))}var a=[],i=[];e.usePlugin=function(){for(var n=arguments.length,r=Array(n),a=0;a<n;a++)r[a]=arguments[a];return r.forEach(t),e},e.hasPlugin=n,e.getPlugins=function(){return a}}function v(e){var t={},n={},r={},a={};e.canDeactivate=function(n,a){var i=Y(a);return t[n]=i,r[n]=e.executeFactory(i),e},e.canActivate=function(t,r){var i=Y(r);return n[t]=i,a[t]=e.executeFactory(i),e},e.getLifecycleFactories=function(){return[t,n]},e.getLifecycleFunctions=function(){return[r,a]},e.clearCanDeactivate=function(n){return t[n]=void 0,r[n]=void 0,e}}function p(e,t){e.clone=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=C({},e.getDependencies(),n),a=t(e.rootNode,e.getOptions(),r);a.useMiddleware.apply(a,I(e.getMiddlewareFactories())),a.usePlugin.apply(a,I(e.getPlugins()));var i=e.getLifecycleFactories(),o=x(i,2),u=o[0],s=o[1];return Object.keys(u).forEach(function(e){return a.canDeactivate(e,u[e])}),Object.keys(s).forEach(function(e){return a.canActivate(e,s[e])}),a}}function m(e){function t(e,t){y[e]=y[e].filter(function(e){return e!==t})}function a(e){e.canActivate&&E.canActivate(e.name,e.canActivate)}function i(e,t,n,r,a){var i={},o=function(e,t){return Object.defineProperty(i,e,{value:t,enumerable:!0})};if(o("name",e),o("params",t),o("path",n),r||a){var u={params:r,id:g+=1};a&&(u.source=a),o("meta",u)}return i}function o(e,t){return"useTrailingSlash"===e&&void 0!==t&&(T.trailingSlash=!0),T[e]=t,E}function u(){return S}function s(){return[E,u()]}var c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=null,g=0,y={},S=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},T=C({},J);Object.keys(c).forEach(function(e){return o(e,c[e])});var E={rootNode:A,getOptions:function(){return T},setOption:o,getState:function(){return l},setState:function(e){l=e},makeState:i,makeNotFoundState:function(e){return i(K.UNKNOWN_ROUTE,{path:e},e,{})},setDependency:function(e,t){return S[e]=t,E},setDependencies:function(e){return Object.keys(e).forEach(function(t){S[t]=e[t]}),E},getDependencies:u,add:function(e){return A.add(e,a),E},addNode:function(e,t,n){return E.rootNode.addNode(e,t),n&&E.canActivate(e,n),E},executeFactory:function(e){return e.apply(void 0,I(s()))},addEventListener:function(e,n){return y[e]=(y[e]||[]).concat(n),function(){return t(e,n)}},removeEventListener:t,invokeEventListeners:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];(y[e]||[]).forEach(function(e){return e.apply(void 0,n)})}};n(E),d(E),h(E),v(E),r(E),f(E),p(E,m);var A=e instanceof z?e:new z("","",e,a);return E.rootNode=A,E}function g(){var e=function(){return console.group("Router transition")},t=function(){return console.groupEnd("Router transition")};return console.info("Router started"),{onStop:function(){console.info("Router stopped")},onTransitionStart:function(n,r){t(),e(),console.log("Transition started from state"),console.log(r),console.log("To state"),console.log(n)},onTransitionCancel:function(){console.warn("Transition cancelled")},onTransitionError:function(e,n,r){console.warn("Transition error with code "+r.code),t()},onTransitionSuccess:function(){console.log("Transition success"),t()}}}var y=function(e){return e.split("?")[0]},S=function(e){return e.split("?")[1]},T=/\[\]$/,E=function(e){return T.test(e)},A=function(e){return e.replace(T,"")},O=function(e){return e.split("&").reduce(function(e,t){var n=t.split("="),r=n[0],a=n[1];return e.concat(1===n.length?{name:r,value:!0}:{name:r,value:decodeURIComponent(a)})},[])},R=function(e){return e.reduce(function(e,t){var n=t.name,r=t.value,a=E(n),i=e[A(n)];return e[A(n)]=void 0===i?a?[r]:r:[].concat(i,r),e},{})},N=function(e){return e.filter(function(e){var t=e.value;return void 0!==t&&null!==t}).map(function(e){var t=e.name,n=e.value;return!0===n?t:t+"="+encodeURIComponent(n)}).join("&")},P=function(e,t){if(!e)return"";var n=O(e).filter(function(e){var n=e.name;return-1===t.indexOf(A(n))});return N(n)||""},b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},k=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),w=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},C=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},x=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(r=(o=u.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{!r&&u.return&&u.return()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),I=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},j=function(e){return"("+(e?e.replace(/(^<|>$)/g,""):"[a-zA-Z0-9-_.~%':]+")+")"},U=[{name:"url-parameter",pattern:/^:([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(e){return new RegExp(j(e[2]))}},{name:"url-parameter-splat",pattern:/^\*([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/,regex:/([^\?]*)/},{name:"url-parameter-matrix",pattern:/^\;([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(e){return new RegExp(";"+e[1]+"="+j(e[2]))}},{name:"query-parameter-bracket",pattern:/^(?:\?|&)(?:\:)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(?:\[\])/},{name:"query-parameter",pattern:/^(?:\?|&)(?:\:)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/},{name:"delimiter",pattern:/^(\/|\?)/,regex:function(e){return new RegExp("\\"+e[0])}},{name:"sub-delimiter",pattern:/^(\!|\&|\-|_|\.|;)/,regex:function(e){return new RegExp(e[0])}},{name:"fragment",pattern:/^([0-9a-zA-Z]+)/,regex:function(e){return new RegExp(e[0])}}],$=function(e){return void 0!==e&&null!==e},D=function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!U.some(function(r){var a=t.match(r.pattern);return!!a&&(n.push({type:r.name,match:a[0],val:a.slice(1,2),otherVal:a.slice(2),regex:r.regex instanceof Function?r.regex(a):r.regex}),a[0].length<t.length&&(n=e(t.substr(a[0].length),n)),!0)}))throw new Error("Could not parse path.");return n},L=function(e,t){return t?e.replace(/\\\/$/,"")+"(?:\\/)?":e},F=function(e,t){return t?/(\/)$/.test(e)?e:e+"(\\/|\\?|\\.|;|$)":e},q=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";/\[\]$/.test(t)&&(t=A(t),n=[n]);var r=e[t];return e[t]=void 0===r?n:Array.isArray(r)?r.concat(n):[r,n],e},M=function(e){var t=S(e);return t?R(O(t)):{}},Q=function(){function e(t){if(_(this,e),!t)throw new Error("Please supply a path");this.path=t,this.tokens=D(t),this.hasUrlParams=this.tokens.filter(function(e){return/^url-parameter/.test(e.type)}).length>0,this.hasSpatParam=this.tokens.filter(function(e){return/splat$/.test(e.type)}).length>0,this.hasMatrixParams=this.tokens.filter(function(e){return/matrix$/.test(e.type)}).length>0,this.hasQueryParams=this.tokens.filter(function(e){return/^query-parameter/.test(e.type)}).length>0,this.spatParams=this._getParams("url-parameter-splat"),this.urlParams=this._getParams(/^url-parameter/),this.queryParams=this._getParams("query-parameter"),this.queryParamsBr=this._getParams("query-parameter-bracket"),this.params=this.urlParams.concat(this.queryParams).concat(this.queryParamsBr),this.source=this.tokens.filter(function(e){return void 0!==e.regex}).map(function(e){return e.regex.source}).join("")}return k(e,null,[{key:"createPath",value:function(t){return new e(t)}},{key:"serialise",value:function(e,n){return t(e,n)}}]),k(e,[{key:"_getParams",value:function(e){var t=e instanceof RegExp?function(t){return e.test(t.type)}:function(t){return t.type===e};return this.tokens.filter(t).map(function(e){return e.val[0]})}},{key:"_isQueryParam",value:function(e){return-1!==this.queryParams.indexOf(e)||-1!==this.queryParamsBr.indexOf(e)}},{key:"_urlTest",value:function(e,t){var n=this,r=e.match(t);return r?this.urlParams.length?r.slice(1,this.urlParams.length+1).reduce(function(e,t,r){return e[n.urlParams[r]]=decodeURIComponent(t),e},{}):{}:null}},{key:"test",value:function(e,t){var n=this,r=C({trailingSlash:!1},t),a=L(this.source,r.trailingSlash),i=this._urlTest(e,new RegExp("^"+a+(this.hasQueryParams?"(\\?.*$|$)":"$")));if(!i||!this.hasQueryParams)return i;var o=M(e);return 0===Object.keys(o).filter(function(e){return-1===n.queryParams.concat(n.queryParamsBr).indexOf(e)}).length?(Object.keys(o).forEach(function(e){return i[e]=o[e]}),i):null}},{key:"partialTest",value:function(e,t){var n=this,r=C({delimited:!0},t),a=F(this.source,r.delimited),i=this._urlTest(e,new RegExp("^"+a));if(!i)return i;if(!this.hasQueryParams)return i;var o=M(e);return Object.keys(o).filter(function(e){return n.queryParams.concat(n.queryParamsBr).indexOf(e)>=0}).forEach(function(e){return q(i,e,o[e])}),i}},{key:"build",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=C({ignoreConstraints:!1,ignoreSearch:!1},r),i=Object.keys(n).reduce(function(t,r){if(!$(n[r]))return t;var a=n[r],i=e._isQueryParam(r)?encodeURIComponent:encodeURI;return"boolean"==typeof a?t[r]=a:Array.isArray(a)?t[r]=a.map(i):t[r]=i(a),t},{});if(this.urlParams.some(function(e){return!$(i[e])}))throw new Error("Missing parameters");if(!a.ignoreConstraints&&!this.tokens.filter(function(e){return/^url-parameter/.test(e.type)&&!/-splat$/.test(e.type)}).every(function(e){return new RegExp("^"+j(e.otherVal[0])+"$").test(i[e.val])}))throw new Error("Some parameters are of invalid format");var o=this.tokens.filter(function(e){return!1===/^query-parameter/.test(e.type)}).map(function(e){return"url-parameter-matrix"===e.type?";"+e.val+"="+i[e.val[0]]:/^url-parameter/.test(e.type)?i[e.val[0]]:e.match}).join("");if(a.ignoreSearch)return o;var u=this.queryParams.concat(this.queryParamsBr.map(function(e){return e+"[]"})).filter(function(e){return-1!==Object.keys(i).indexOf(A(e))}).map(function(e){return t(e,i[A(e)])}).join("&");return o+(u?"?"+u:"")}}]),e}(),B=function(){},z=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments[3],i=arguments[4];return _(this,e),this.name=t,this.absolute=/^~/.test(n),this.path=this.absolute?n.slice(1):n,this.parser=this.path?new Q(this.path):null,this.children=[],this.parent=i,this.checkParents(),this.add(r,a),this}return k(e,[{key:"checkParents",value:function(){if(this.absolute&&this.hasParentsParams())throw new Error("[RouteNode] A RouteNode with an abolute path cannot have parents with route parameters")}},{key:"hasParentsParams",value:function(){if(this.parent&&this.parent.parser){var e=this.parent.parser;return e.hasUrlParams||e.hasSpatParam||e.hasMatrixParams||e.hasQueryParams||this.parent.hasParentsParams()}return!1}},{key:"getNonAbsoluteChildren",value:function(){return this.children.filter(function(e){return!e.absolute})}},{key:"findAbsoluteChildren",value:function(){return this.children.reduce(function(e,t){return e.concat(t.absolute?t:[]).concat(t.findAbsoluteChildren())},[])}},{key:"findSlashChild",value:function(){return this.getNonAbsoluteChildren().filter(function(e){return e.parser&&/^\/(\?|$)/.test(e.parser.path)})[0]}},{key:"getParentSegments",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return this.parent&&this.parent.parser?this.parent.getParentSegments(e.concat(this.parent)):e.reverse()}},{key:"setParent",value:function(e){this.parent=e,this.checkParents()}},{key:"setPath",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.path=e,this.parser=e?new Q(e):null}},{key:"add",value:function(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:B,a=void 0;if(void 0!==t&&null!==t){if(!(t instanceof Array)){if(!(t instanceof e||t instanceof Object))throw new Error("RouteNode.add() expects routes to be an Object or an instance of RouteNode.");if(t instanceof e)t.setParent(this);else{if(!t.name||!t.path)throw new Error("RouteNode.add() expects routes to have a name and a path defined.");a=t,t=new e(t.name,t.path,t.children,r,this)}var i=t.name.split(".");if(1===i.length){if(-1!==this.children.map(function(e){return e.name}).indexOf(t.name))throw new Error('Alias "'+t.name+'" is already defined in route node');if(-1!==this.children.map(function(e){return e.path}).indexOf(t.path))throw new Error('Path "'+t.path+'" is already defined in route node');this.children.push(t),this.children.sort(function(e,t){var n=e.path.split("?")[0].replace(/(.+)\/$/,"$1"),r=t.path.split("?")[0].replace(/(.+)\/$/,"$1");if("/"===n)return 1;if("/"===r)return-1;if(e.parser.hasSpatParam)return 1;if(t.parser.hasSpatParam)return-1;var a=(n.match(/\//g)||[]).length,i=(r.match(/\//g)||[]).length;if(a<i)return 1;if(a>i)return-1;var o=e.parser.urlParams.length,u=t.parser.urlParams.length;if(o<u)return-1;if(o>u)return 1;var s=(n.split("/").slice(-1)[0]||"").length,c=(r.split("/").slice(-1)[0]||"").length;return s<c?1:s>c?-1:0})}else{var o=this.getSegmentsByName(i.slice(0,-1).join("."));if(!o)throw new Error("Could not add route named '"+t.name+"', parent is missing.");t.name=i[i.length-1],o[o.length-1].add(t)}if(a){var u=t.getParentSegments([t]).map(function(e){return e.name}).join(".");r(C({},a,{name:u}))}return this}t.forEach(function(e){return n.add(e,r)})}}},{key:"addNode",value:function(t,n){return this.add(new e(t,n)),this}},{key:"getSegmentsByName",value:function(e){var t=function(e,t){var n=t.filter(function(t){return t.name===e});return n.length?n[0]:void 0},n=[],r=this.parser?[this]:this.children;return(this.parser?[""]:[]).concat(e.split(".")).every(function(e){var a=t(e,r);return!!a&&(r=a.children,n.push(a),!0)})?n:null}},{key:"getSegmentsMatchingPath",value:function(e,t){var n=t.trailingSlash,r=t.strictQueryParams,a=t.strongMatching,i=(this.parser?[this]:this.children).reduce(function(e,t){return e.concat(t,t.findAbsoluteChildren())},[]),o=[];o.params={};var u=function e(t,i,o){for(var u=1===t.length&&""===t[0].name,s=0;s<t.length;s+=1){var c=function(s){var c=t[s],l=void 0,f=void 0;if(c.children.length||(l=c.parser.test(i,{trailingSlash:n})),l||(l=c.parser.partialTest(i,{delimiter:a})),l){var h=c.parser.build(l,{ignoreSearch:!0});n&&!c.children.length&&(h=h.replace(/\/$/,"")),f=i.replace(h,""),n&&!c.children.length&&(f=f.replace(/^\/\?/,"?"));var d=P(S(i.replace(h,"")),c.parser.queryParams.concat(c.parser.queryParamsBr));if(f=y(f)+(d?"?"+d:""),!n||u||"/"!==f||/\/$/.test(h)||(f=""),o.push(c),Object.keys(l).forEach(function(e){return o.params[e]=l[e]}),!u&&!f.length)return{v:o};if(!u&&!r&&0===f.indexOf("?"))return O(f.slice(1)).forEach(function(e){var t=e.name,n=e.value;return o.params[t]=n}),{v:o};var v=c.getNonAbsoluteChildren();return v.length?{v:e(v,f,o)}:{v:null}}}(s);if("object"===(void 0===c?"undefined":b(c)))return c.v}return null}(i,e,o);return u&&1===u.length&&""===u[0].name?null:u}},{key:"getPathFromSegments",value:function(e){return e?e.map(function(e){return e.path}).join(""):null}},{key:"getPath",value:function(e){return this.getPathFromSegments(this.getSegmentsByName(e))}},{key:"buildPathFromSegments",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!e)return null;for(var r=[],a=[],i=0;i<e.length;i+=1){var o=e[i].parser;r.push.apply(r,I(o.queryParams)),r.push.apply(r,I(o.queryParamsBr)),a.push.apply(a,I(o.urlParams)),a.push.apply(a,I(o.spatParams))}if(!n.strictQueryParams){var u=Object.keys(t).reduce(function(e,t){return-1===r.indexOf(t)&&-1===a.indexOf(t)?e.concat(t):e},[]);r.push.apply(r,I(u))}var s=r.length?r.filter(function(e){if(-1===Object.keys(t).indexOf(A(e)))return!1;var n=t[A(e)];return void 0!==n&&null!==n}).map(function(e){var n=t[A(e)],r=Array.isArray(n)?n.map(encodeURIComponent):encodeURIComponent(n);return Q.serialise(e,r)}).join("&"):null;return e.reduce(function(e,n){var r=n.parser.build(t,{ignoreSearch:!0});return n.absolute?r:e+r},"")+(s?"?"+s:"")}},{key:"getMetaFromSegments",value:function(e){var t="";return e.reduce(function(e,n){var r=n.parser.urlParams.reduce(function(e,t){return e[t]="url",e},{}),a=n.parser.queryParams.reduce(function(e,t){return e[t]="query",e},r);return void 0!==n.name&&(e[t=t?t+"."+n.name:n.name]=a),e},{})}},{key:"buildPath",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=C({},{strictQueryParams:!0},n),a=this.buildPathFromSegments(this.getSegmentsByName(e),t,r);return!0===r.trailingSlash?/\/$/.test(a)?a:a+"/":!1===r.trailingSlash&&/\/$/.test(a)?a.slice(0,-1):a}},{key:"buildStateFromSegments",value:function(e){return e&&e.length?{name:e.map(function(e){return e.name}).filter(function(e){return e}).join("."),params:e.params,_meta:this.getMetaFromSegments(e)}:null}},{key:"buildState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.getSegmentsByName(e);return n&&n.length?{name:e,params:t,_meta:this.getMetaFromSegments(n)}:null}},{key:"matchPath",value:function(e,t){var n=C({},{trailingSlash:!1,strictQueryParams:!0,strongMatching:!0},t),r=this.getSegmentsMatchingPath(e,n);if(r){if(r[0].absolute){var a=r[0].getParentSegments();r.reverse(),r.push.apply(r,I(a)),r.reverse()}var i=r[r.length-1].findSlashChild();i&&r.push(i)}return this.buildStateFromSegments(r)}}]),e}(),Z={ROUTER_NOT_STARTED:"NOT_STARTED",NO_START_PATH_OR_STATE:"NO_START_PATH_OR_STATE",ROUTER_ALREADY_STARTED:"ALREADY_STARTED",ROUTE_NOT_FOUND:"ROUTE_NOT_FOUND",SAME_STATES:"SAME_STATES",CANNOT_DEACTIVATE:"CANNOT_DEACTIVATE",CANNOT_ACTIVATE:"CANNOT_ACTIVATE",TRANSITION_ERR:"TRANSITION_ERR",TRANSITION_CANCELLED:"CANCELLED"},K={UNKNOWN_ROUTE:"@@router5/UNKNOWN_ROUTE",ROUTER_START:"$start",ROUTER_STOP:"$stop",TRANSITION_START:"$$start",TRANSITION_CANCEL:"$$cancel",TRANSITION_SUCCESS:"$$success",TRANSITION_ERROR:"$$error"},V=function(){},W="function"==typeof Symbol&&"symbol"===b(Symbol.iterator)?function(e){return void 0===e?"undefined":b(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":b(e)},G=function(){},H=["onStart","onStop","onTransitionSuccess","onTransitionStart","onTransitionError","onTransitionCancel"],Y=function(e){return"function"==typeof e?e:function(){return function(){return e}}},J={trailingSlash:0,useTrailingSlash:void 0,autoCleanUp:!0,strictQueryParams:!1,allowNotFound:!1,strongMatching:!0};g.pluginName="LOGGER_PLUGIN",e.default=m,e.createRouter=m,e.RouteNode=z,e.loggerPlugin=g,e.errorCodes=Z,e.transitionPath=s,e.constants=K,Object.defineProperty(e,"__esModule",{value:!0})});
